package main

import (
	"io/ioutil"
	"log"
	"net/http"
	"os"
	"strconv"
	"strings"
)

var pageContents []byte

func main() {
	if len(os.Args) != 3 {
		log.Fatal("Usage: server <port> <page.html>")
	}

	_, err := strconv.Atoi(os.Args[1])
	if err != nil {
		log.Fatal("Failed to parse port:", err)
	}

	pagePath := os.Args[2]
	pageContents, err = ioutil.ReadFile(pagePath)
	if err != nil {
		log.Fatal("Failed to read page:", err)
	}
	AddFaviconLine()

	http.HandleFunc("/favicon.ico", ServeFavicon)
	http.HandleFunc("/", ServeHome)
	http.ListenAndServe(":"+os.Args[1], nil)
}

func AddFaviconLine() {
	strContents := string(pageContents)
	strContents = strings.Replace(strContents, "<!-- Favicon code here -->",
		"<link rel=\"shortcut icon\" href=\"favicon.ico\" type=\"image/x-icon\" />"+
			"<link rel=\"icon\" href=\"favicon.ico\" type=\"image/x-icon\" />", 1)
	pageContents = []byte(strContents)
}

func ServeFavicon(w http.ResponseWriter, r *http.Request) {
	log.Print("Host " + r.RemoteAddr + " requested /favicon.ico for host " + r.Host)
	w.Header().Set("Content-Type", "image/x-icon")
	w.Header().Set("Content-Length", strconv.Itoa(len(faviconData)))
	w.Write(faviconData)
}

func ServeHome(w http.ResponseWriter, r *http.Request) {
	log.Print("Host " + r.RemoteAddr + " requested " + r.URL.Path + " for host " + r.Host)
	if r.URL.Path != "/" && r.URL.Path != "" {
		http.NotFound(w, r)
		return
	}
	w.Header().Set("Content-Type", "text/html")
	w.Header().Set("Content-Length", strconv.Itoa(len(pageContents)))
	w.Write(pageContents)
}

var faviconData []byte = []byte("\x00\x00\x01\x00\x01\x00\x10\x10\x00\x00\x00\x00\x20\x00\x68\x04\x00\x00\x16\x00\x00\x00\x28\x00\x00\x00\x10\x00\x00\x00\x20\x00\x00\x00\x01\x00\x20\x00\x00\x00\x00\x00\x40\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xCE\xCE\xCE\x2F\xCE\xCE\xCE\x2F\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xCD\xCD\xCD\x7F\xCD\xCD\xCD\x7F\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xF0\xF0\xF0\x23\xF0\xF0\xF0\x35\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xCB\xCB\xCB\x81\xCB\xCB\xCB\x81\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xAA\xAA\xAA\x33\xA8\xA8\xA8\x23\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xEC\xEC\xEC\x35\xEE\xEE\xEE\xEB\xEF\xEF\xEF\x41\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xCB\xCB\xCB\x81\xCB\xCB\xCB\x81\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xAB\xAB\xAB\x41\xAA\xAA\xAA\xEB\xAC\xAC\xAC\x35\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xEE\xEE\xEE\x3D\xED\xED\xED\xE9\xF0\xF0\xF0\x43\xFF\xFF\xFF\x01\xCB\xCB\xCB\x81\xCB\xCB\xCB\x81\xFF\xFF\xFF\x01\xAA\xAA\xAA\x3D\xAA\xAA\xAA\xE9\xAA\xAA\xAA\x43\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xEF\xEF\xEF\x41\xEE\xEE\xEE\xEB\xEE\xEE\xEE\x2F\xCE\xCE\xCE\x2F\xCE\xCE\xCE\x2F\xA8\xA8\xA8\x2F\xAA\xAA\xAA\xEB\xAB\xAB\xAB\x41\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xEE\xEE\xEE\x2D\xF3\xF3\xF3\x15\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xAA\xAA\xAA\x15\xAC\xAC\xAC\x2F\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x00\x00\x00\x2F\x00\x00\x00\x89\x00\x00\x00\x89\x00\x00\x00\x89\x00\x00\x00\x89\x00\x00\x00\x2F\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x88\x88\x88\x2F\x89\x89\x89\x89\x89\x89\x89\x89\x89\x89\x89\x89\x89\x89\x89\x89\x88\x88\x88\x2F\x00\x00\x00\x2F\x00\x00\x00\x77\x00\x00\x00\x77\x00\x00\x00\x77\x00\x00\x00\x77\x00\x00\x00\x2F\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x88\x88\x88\x2F\x87\x87\x87\x77\x87\x87\x87\x77\x87\x87\x87\x77\x87\x87\x87\x77\x88\x88\x88\x2F\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x22\x22\x22\x2D\x24\x24\x24\x15\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x61\x61\x61\x15\x64\x64\x64\x2F\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x24\x24\x24\x41\x22\x22\x22\xEB\x21\x21\x21\x2F\x47\x47\x47\x2F\x47\x47\x47\x2F\x67\x67\x67\x2F\x66\x66\x66\xEB\x68\x68\x68\x41\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x22\x22\x22\x3D\x22\x22\x22\xE9\x23\x23\x23\x43\xFF\xFF\xFF\x01\x44\x44\x44\x7F\x44\x44\x44\x7F\xFF\xFF\xFF\x01\x64\x64\x64\x3D\x66\x66\x66\xE9\x64\x64\x64\x43\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x22\x22\x22\x35\x22\x22\x22\xEB\x24\x24\x24\x41\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x44\x44\x44\x81\x44\x44\x44\x81\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x68\x68\x68\x41\x66\x66\x66\xEB\x67\x67\x67\x35\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x24\x24\x24\x23\x22\x22\x22\x35\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x44\x44\x44\x81\x44\x44\x44\x81\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x64\x64\x64\x33\x66\x66\x66\x23\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x44\x44\x44\x81\x44\x44\x44\x81\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x47\x47\x47\x2F\x47\x47\x47\x2F\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\xFF\xFF\xFF\x01\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF\x00\x00\xFF\xFF")
